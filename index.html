<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Improv Timer v27</title>
<style>
  :root{
    --blue:#3aa8ff;   /* segment 1 (Blue) */
    --green:#25d366;  /* segment 2 (Green) */
    --red:#ff3b00;    /* segment 3 (Red) */

    --bg:#000;
    --fg:#fff;

    --band-min:26px;
    --band-max:22vh;

    /* Overtime palette */
    --overtime-yellow:#ffff00; /* whole background in OT */
    --overtime-blue:#0044ff;   /* strong blue digits in OT */
  }

  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    overflow:hidden;
    -webkit-tap-highlight-color: transparent;
    transition:background-color .2s linear;
  }

  /* Whole screen turns bright yellow in overtime */
  body.overtime{ background:var(--overtime-yellow); }

  .app{position:relative;height:100%;width:100%;display:flex;flex-direction:column;}
  .field{
    position:relative;flex:1 1 auto;
    display:grid;grid-template-rows:1fr auto;grid-template-columns:100%;
  }

  /* ===== CLOCK STRIP ===== */
  .clock-strip{
    position:relative;z-index:2;
    background:#000;                /* normal = black; in OT we set transparent to let yellow show */
    display:flex;align-items:center;justify-content:center;user-select:none;
    transition:background .15s linear;
  }
  .time-rot{transform-origin:center;}
  .portrait .time-rot{ transform: rotate(-90deg); }  /* portrait: bottom→top */
  .landscape .time-rot{ transform: none; }

  .time{
    display:block;line-height:0.88;font-weight:900;letter-spacing:0.005em;white-space:nowrap;
    text-shadow:0 0 22px rgba(0,0,0,.7);
    color:var(--blue); /* Blue→Green→Red; overtime = --overtime-blue (via JS) */
    font-size:10vw;    /* auto-fitted by JS */
    transition:opacity .12s linear, color .12s linear;
  }

  /* OVERTIME vertical ribbon (full height on the left) – “OVER” / “TIME” */
  .overtime-ribbon{
    position:absolute;left:10px;top:0;bottom:0;z-index:4;
    width:58px;display:none;align-items:center;justify-content:center;
    background:rgba(255,0,0,0.18);
    border-left:1px solid rgba(255,0,0,0.55);
    border-right:1px solid rgba(255,0,0,0.35);
    backdrop-filter:blur(1px);
  }
  .overtime .overtime-ribbon{ display:flex; }
  .overtime-text{
    writing-mode:vertical-lr; text-orientation:upright;
    white-space:pre-line;
    font-weight:900;font-size:14px;letter-spacing:0.8px;color:#fff;text-shadow:0 0 8px rgba(0,0,0,.5);
    user-select:none;
  }

  /* Minute blink mask in final (pre-end) segment */
  .blink-mask{position:absolute;inset:0;background:#000;pointer-events:none;z-index:3;display:none;}

  /* ===== BOTTOM PROGRESS BAND ===== */
  .band{
    position:relative;min-height:var(--band-min);max-height:var(--band-max);
    height:clamp(var(--band-min),15vh,var(--band-max));
    overflow:hidden;z-index:1;
  }
  .segments{position:absolute;inset:0;display:flex;pointer-events:none;}
  .seg{height:100%;width:0}
  .seg.blue{background:var(--blue)}
  .seg.green{background:var(--green)}
  .seg.red{background:var(--red)}

  .markers{position:absolute;inset:0;pointer-events:none;}
  .marker{position:absolute;top:0;bottom:0;width:2px;}
  .marker.blue{background:var(--blue)}
  .marker.green{background:var(--green)}
  .marker.end{background:var(--red);width:5px;}

  .marker-label{
    position:absolute;bottom:6px;transform:translateX(-8px);
    font-size:12px;font-weight:800;font-variant-numeric:tabular-nums;
    padding:2px 6px;border-radius:6px;white-space:nowrap;
    background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);
  }
  .marker-label.blue{color:var(--blue)}
  .marker-label.green{color:var(--green)}

  /* (Removed the extra total-overlay chip entirely) */

  /* Bottom info bar */
  .bar{flex:0 0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px;
    background:rgba(0,0,0,.55);backdrop-filter:blur(4px);border-top:1px solid rgba(255,255,255,.08);
    font-size:clamp(12px,2.4vw,18px);z-index:5;}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;
    display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
  .dot.blue{background:var(--blue)} .dot.green{background:var(--green)} .dot.red{background:var(--red)}
  .bar .spacer{flex:1}
  .bar strong#totalShow{font-size:1.25em}

  /* Start slab (left 20%) — button fills vertically */
  .start-slab{position:absolute;left:0;top:0;bottom:0;width:20%;display:flex;align-items:stretch;justify-content:center;
    background:rgba(58,168,255,0.07);border-right:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none;z-index:6;}
  .start-slab button{width:92%;height:100%;max-width:420px;border-radius:0;
    border:2px solid rgba(255,255,255,.28);background:var(--blue);color:#002235;font-weight:900;font-size:clamp(22px,4.2vw,34px);cursor:pointer;}
  .start-hidden{display:none;}

  /* ===== Settings (responsive & compact) ===== */
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.66);display:none;align-items:center;justify-content:center;z-index:11;}
  .sheet.open{display:flex}
  .card{width:min(880px,94vw);max-height:92vh;background:#0b0b0b;color:var(--fg);
    border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);
    padding:0;display:flex;flex-direction:column;overflow:hidden;}
  .card-header{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,#0b0b0b 85%,rgba(11,11,11,0) 100%);
    padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:flex-end;justify-content:space-between;gap:8px;}
  .card-title{margin:0;font-size:16px;font-weight:800;}

  /* Button color lock */
  .btn, .btn:focus, .btn:active { outline: none; }
  .btn{border:1px solid rgba(255,255,255,.18);background:#101010;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;font-size:14px;user-select:none;}
  .btn.primary{background:var(--blue);color:#002235}
  .btn.warn{background:#1a0000;color:#ffb3b3;border-color:#551111}
  .btn.neutral{background:#0f0f0f}
  .btn:active{transform:scale(0.98)}
  .btn.primary:active{background:var(--blue)}
  .btn.warn:active{background:#1a0000}
  .btn.neutral:active{background:#0f0f0f}

  .status{display:flex;align-items:center;gap:8px;font-variant-numeric:tabular-nums;background:rgba(255,255,255,.06);
    padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);font-size:12px;}
  .status .dot{width:9px;height:9px;border-radius:50%;}
  .status .dot.run{background:#28d17c}
  .status .dot.pause{background:#ffb020}
  .status .dot.reset{background:#aaaaaa}
  .mini-time{font-weight:900;letter-spacing:0.02em}
  .mini-total{opacity:.8}
  .mini-divider{opacity:.6}

  .card-body{padding:10px 12px;overflow:auto;}
  .row{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap;}
  .row + .row{margin-top:10px;}
  .group{flex:1 1 240px;min-width:240px;max-width:100%;
    background:#121212;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px;}
  .group.themed{--theme:#fff;}
  .group.themed h4{margin:0 0 6px 0;display:flex;align-items:center;gap:6px;font-size:14px;color:var(--theme)}
  .group.themed .lbl{color:var(--theme);opacity:.9}
  .group.themed .val{border:1px dashed rgba(255,255,255,.24);color:var(--theme)}
  .group.themed .btnStep{border:1px solid rgba(255,255,255,.24);color:#000;background:#e6e6e6;}
  .group.blue  { --theme: var(--blue); }
  .group.green { --theme: var(--green); }
  .group.red   { --theme: var(--red); }

  .counter{display:flex;align-items:center;gap:6px;margin-top:6px;flex-wrap:nowrap;}
  .lbl{opacity:.8;font-size:11px;min-width:64px}
  .btnStep{padding:6px 8px;border-radius:10px;font-weight:800;cursor:pointer;min-width:36px;text-align:center;font-size:12px}
  .val{padding:6px 8px;border-radius:10px;min-width:56px;text-align:center;font-variant-numeric:tabular-nums;background:#0b0b0b;border:1px dashed rgba(255,255,255,.24);color:#fff;}
  .btnDelete{padding:6px 8px;border-radius:10px;font-weight:800;cursor:pointer;border:1px solid #522;background:#1a0000;color:#ffb3b3;font-size:12px}

  /* Preview clock block for landscape (4th quadrant) */
  .group.preview{
    display:none;
    align-items:center;justify-content:center;text-align:center;gap:8px;
  }
  .previewTitle{font-weight:800;font-size:13px;opacity:.9;margin:0 0 6px 0}
  .previewClock{
    font-weight:900;font-variant-numeric:tabular-nums;
    font-size:clamp(22px,5vw,48px);
    line-height:1; letter-spacing:0.02em;
    background:#000;border-radius:10px;padding:10px 12px;display:inline-block;
    border:1px solid rgba(255,255,255,.14);
  }
  .previewState{margin-top:6px;font-size:12px;opacity:.85}

  .card-footer{
    position:sticky;bottom:0;z-index:2;
    background:linear-gradient(0deg,#0b0b0b 82%,rgba(11,11,11,0) 100%);
    border-top:1px solid rgba(255,255,255,.12);
    padding:8px 12px calc(8px + env(safe-area-inset-bottom)) 12px;
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  }

  /* Portrait-specific tightening */
  @media (orientation:portrait) {
    .card{width:96vw;max-height:90vh;}
    .row{gap:8px}
    .group{min-width:220px;padding:8px}
    .group.themed h4{font-size:13px}
    .lbl{min-width:56px;font-size:10.5px}
    .btnStep{min-width:34px;padding:6px 6px;font-size:12px}
    .val{min-width:50px}
    .btnDelete{font-size:11.5px;padding:6px 8px}
    .group.preview{display:none;}
  }

  /* Landscape: grid 2×2 with preview at 4th quadrant */
  @media (orientation:landscape) {
    .card-body .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: minmax(140px, auto);
      gap:10px;
    }
    .group.preview{display:flex;flex-direction:column;}
    .group.blue  { order:1; }
    .group.green { order:2; }
    .group.red   { order:3; }
    .group.preview { order:4; }
  }

  /* Watermark – main only first 10s; hidden in settings */
  .stamp{position:fixed;right:10px;top:8px;z-index:10;font-size:12px;opacity:0.85;letter-spacing:0.4px;
    background:rgba(0,0,0,0.35);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);pointer-events:none;}
  .stamp.hidden{display:none;}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="stamp" id="stamp">08.09.2025 - v27 - Jimmy James</div>

    <div class="field" id="field">
      <!-- CLOCK -->
      <div class="clock-strip" id="clockStrip">
        <div class="overtime-ribbon" id="otRibbon"><span class="overtime-text">OVER
TIME</span></div>
        <div class="time-rot"><span class="time" id="clock">0:00</span></div>
        <div class="blink-mask" id="blinkMask"></div>
      </div>

      <!-- BOTTOM progress band -->
      <div class="band" id="bandBottom">
        <div class="segments">
          <div class="seg blue"  id="segB"></div>
          <div class="seg green" id="segG"></div>
          <div class="seg red"   id="segR"></div>
        </div>
        <div class="markers">
          <div class="marker blue"  id="lineB"></div>
          <div class="marker green" id="lineG"></div>
          <div class="marker end"   id="lineEnd"></div>
          <!-- Labels (blue/green only) -->
          <div class="marker-label blue"  id="labelB">4:00</div>
          <div class="marker-label green" id="labelG">14:00</div>
        </div>
        <!-- (Removed the total-overlay chip here) -->
      </div>

      <!-- Big left START slab -->
      <div class="start-slab" id="startSlab">
        <button id="startBtn">START</button>
      </div>
    </div>

    <!-- Bottom info bar (kept) -->
    <div class="bar">
      <span class="pill"><span class="dot blue"></span><span id="bShow">4:00</span></span>
      <span class="pill"><span class="dot green"></span><span id="gShow">10:00</span></span>
      <span class="pill"><span class="dot red"></span><span id="rShow">6:00</span></span>
      <div class="spacer"></div>
      <span class="pill" title="Total time"><strong id="totalShow">20:00</strong></span>
    </div>

    <!-- Settings (opens via triple tap anywhere) -->
    <div class="sheet" id="sheet">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Improv Timer Settings</h2>
          <div class="status" id="statusBox">
            <span class="dot pause" id="miniDot"></span>
            <span id="miniStatus">Paused</span>
            <span class="mini-divider">·</span>
            <span class="mini-time" id="miniClock">0:00</span>
            <span class="mini-total" id="miniTotal">/ 20:00</span>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <!-- 1. Blue -->
            <div class="group themed blue">
              <h4><span>1.</span> <span class="dot blue"></span> <strong>Blue</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="-1">−</button>
                <span class="val" id="bMinVal">4</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="b" title="Set Blue to 0">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="bSecOnly">00</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <!-- 2. Green -->
            <div class="group themed green">
              <h4><span>2.</span> <span class="dot green"></span> <strong>Green</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="-1">−</button>
                <span class="val" id="gMinVal">10</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="g" title="Set Green to 0">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="gSecOnly">00</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <!-- 3. Red -->
            <div class="group themed red">
              <h4><span>3.</span> <span class="dot red"></span> <strong>Red</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="-1">−</button>
                <span class="val" id="rMinVal">6</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="r" title="Set Red to 0">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="rSecOnly">00</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <!-- 4. Preview clock (landscape only) -->
            <div class="group preview" id="previewBlock">
              <h4 class="previewTitle">Preview</h4>
              <div class="previewClock" id="previewClock">0:00</div>
              <div class="previewState" id="previewState">Paused</div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn" id="pauseBtn">Pause</button>
          <button class="btn primary" id="returnBtn">Return</button>
          <button class="btn warn" id="resetBtn" title="Reset timer to 0">Reset</button>
          <button class="btn neutral" id="defaultBtn" title="Restore 4/10/6">Default</button>
          <button class="btn warn" id="deleteAllBtn" title="Press 3× to delete all">Delete All (×3)</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const root = document.body;

  const clock = document.getElementById('clock');
  const clockStrip = document.getElementById('clockStrip');

  const segB = document.getElementById('segB');
  const segG = document.getElementById('segG');
  const segR = document.getElementById('segR');

  const lineB = document.getElementById('lineB');
  const lineG = document.getElementById('lineG');
  const lineEnd = document.getElementById('lineEnd');
  const labelB = document.getElementById('labelB');
  const labelG = document.getElementById('labelG');

  const blinkMask = document.getElementById('blinkMask');

  const bShow = document.getElementById('bShow');
  const gShow = document.getElementById('gShow');
  const rShow = document.getElementById('rShow');
  const totalShow = document.getElementById('totalShow');

  const startSlab = document.getElementById('startSlab');
  const startBtn = document.getElementById('startBtn');

  const sheet = document.getElementById('sheet');
  const pauseBtn = document.getElementById('pauseBtn');
  const returnBtn = document.getElementById('returnBtn');
  const resetBtn = document.getElementById('resetBtn');
  const defaultBtn = document.getElementById('defaultBtn');
  const deleteAllBtn = document.getElementById('deleteAllBtn');

  const miniDot = document.getElementById('miniDot');
  const miniStatus = document.getElementById('miniStatus');
  const miniClock = document.getElementById('miniClock');
  const miniTotal = document.getElementById('miniTotal');

  const previewClock = document.getElementById('previewClock');
  const previewState = document.getElementById('previewState');

  const stamp = document.getElementById('stamp');

  // Defaults (Blue→Green→Red)
  const DEFAULT_B = 4*60, DEFAULT_G = 10*60, DEFAULT_R = 6*60;
  let bSec = DEFAULT_B, gSec = DEFAULT_G, rSec = DEFAULT_R;
  let totalSec = bSec + gSec + rSec;

  let elapsed = 0; // keeps counting past total
  let running = false;
  let rafId = null;
  let lastTick = null;

  let scheduledFinalBlinks = new Set();
  let blinking = false;
  let otBlinkMinuteDone = -1;

  // Watermark: auto-hide after 10s, hide while settings is open
  setTimeout(()=> stamp.classList.add('hidden'), 10000);
  function updateStampVisibility(){
    const inSettings = sheet.classList.contains('open');
    if (inSettings) stamp.classList.add('hidden');
  }

  /* ---------- Orientation + Giant clock fitting ---------- */
  function applyOrientationClass(){
    const portrait = window.innerHeight >= window.innerWidth;
    root.classList.toggle('portrait', portrait);
    root.classList.toggle('landscape', !portrait);
  }

  function fitClock(){
    const rect = clockStrip.getBoundingClientRect();
    if (rect.width <= 0 || rect.height <= 0) return;

    const isPortrait = root.classList.contains('portrait');

    if (isPortrait){
      const maxRotW = rect.width * 0.998;
      const maxRotH = rect.height * 0.992;
      let lo=6, hi=Math.max(24, rect.height*2.2);
      const fits = (px)=>{
        clock.style.fontSize = px + 'px';
        const W = clock.scrollWidth, H = clock.scrollHeight;
        const rotW = H, rotH = W;
        return (rotW <= maxRotW) && (rotH <= maxRotH);
      };
      while (fits(hi)) hi *= 1.2;
      while (hi - lo > 1){ const mid = Math.floor((lo+hi)/2); if (fits(mid)) lo = mid; else hi = mid; }
      clock.style.fontSize = lo + 'px';
    } else {
      const maxW = rect.width * 0.998;
      const maxH = rect.height * 0.985;
      let lo=6, hi=Math.max(24, rect.height*2.1);
      const fits = (px)=>{
        clock.style.fontSize = px + 'px';
        const W = clock.scrollWidth, H = clock.scrollHeight;
        return (H <= maxH) && (W <= maxW);
      };
      while (fits(hi)) hi *= 1.2;
      while (hi - lo > 1){ const mid = Math.floor((lo+hi)/2); if (fits(mid)) lo = mid; else hi = mid; }
      clock.style.fontSize = lo + 'px';
    }
  }
  const fitClockThrottled = throttle(()=>{ applyOrientationClass(); fitClock(); }, 50);

  /* ---------- Format ---------- */
  function fmtSS(t){
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  /* ---------- Digit color per segment; OVERTIME -> BLUE ---------- */
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function updateDigitColor(){
    const bEnd = bSec, gEnd = bSec + gSec;
    if (elapsed < bEnd)          clock.style.color = getVar('--blue');
    else if (elapsed < gEnd)     clock.style.color = getVar('--green');
    else if (elapsed < totalSec) clock.style.color = getVar('--red');
    else                         clock.style.color = getVar('--overtime-blue'); // overtime = strong blue
  }

  /* ---------- Markers & labels ---------- */
  function positionMarkers(){
    if (totalSec <= 0){
      lineB.style.left='0%'; lineG.style.left='0%'; lineEnd.style.left='calc(100% - 2.5px)';
      labelB.textContent='0:00'; labelG.textContent='0:00';
      labelB.style.left='0%'; labelG.style.left='0%';
      return;
    }
    const bPct = (bSec/totalSec)*100;
    const gPct = ((bSec+gSec)/totalSec)*100;

    lineB.style.left   = `calc(${bPct}% - 1px)`;
    lineG.style.left   = `calc(${gPct}% - 1px)`;
    lineEnd.style.left = `calc(100% - 2.5px)`;

    labelB.textContent  = fmtSS(bSec);
    labelG.textContent  = fmtSS(bSec+gSec);
    labelB.style.left   = `calc(${bPct}% - 24px)`;
    labelG.style.left   = `calc(${gPct}% - 32px)`;
  }

  function refreshInfoBar(){
    bShow.textContent = fmtSS(bSec);
    gShow.textContent = fmtSS(gSec);
    rShow.textContent = fmtSS(rSec);
    const totalTxt = fmtSS(totalSec);
    totalShow.textContent = totalTxt;
    miniTotal.textContent = `/ ${totalTxt}`;
  }

  /* ---------- Mini status + Preview in settings ---------- */
  function setMiniStatus(){
    const txt = fmtSS(elapsed);
    miniClock.textContent = txt;
    previewClock.textContent = txt;

    let st;
    if (elapsed === 0 && !running){ st='Reset'; miniDot.className='dot reset'; }
    else if (running){ st='Running'; miniDot.className='dot run'; }
    else { st='Paused'; miniDot.className='dot pause'; }

    miniStatus.textContent = st;
    previewState.textContent = st;
  }

  /* ---------- Segments fill ---------- */
  function updateSegments(sec){
    if (totalSec <= 0){ segB.style.width='0%'; segG.style.width='0%'; segR.style.width='0%'; return; }
    const eff = Math.min(sec, totalSec);
    const pctTotal = (eff/totalSec)*100;

    const bPct = (bSec/totalSec)*100;
    const gPct = (gSec/totalSec)*100;
    const rPct = 100 - bPct - gPct;

    segB.style.width = Math.min(pctTotal, bPct) + '%';
    segG.style.width = Math.min(Math.max(pctTotal - bPct, 0), gPct) + '%';
    segR.style.width = Math.min(Math.max(pctTotal - bPct - gPct, 0), rPct) + '%';
  }

  /* ---------- Timer control ---------- */
  function start(){
    if (running || totalSec === 0) return;
    running = true;
    startSlab.classList.add('start-hidden');
    clockStrip.style.background = '#000';
    root.classList.remove('overtime'); // reset body bg
    lastTick = performance.now();
    setMiniStatus();
    updateStampVisibility();
    tick();
  }
  function pause(){
    running = false;
    if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
    startSlab.classList.remove('start-hidden');
    setMiniStatus();
    updateStampVisibility();
  }
  function resetElapsed(){
    elapsed = 0;
    scheduledFinalBlinks.clear();
    blinking = false;
    blinkMask.style.display = 'none';
    otBlinkMinuteDone = -1;
    clock.style.opacity = '1';
    clockStrip.style.background = '#000';
    root.classList.remove('overtime');
    clock.textContent = fmtSS(0);
    updateDigitColor();
    updateSegments(0);
    setMiniStatus();
    fitClockThrottled();
    updateStampVisibility();
  }

  function tick(now){
    if (!running) return;
    if (!now) now = performance.now();
    const dt = (now - lastTick) / 1000;
    if (dt >= 0.25){
      const add = Math.floor(dt);
      elapsed += add;
      lastTick += add*1000;

      clock.textContent = fmtSS(elapsed);

      updateDigitColor();
      fitClockThrottled();

      updateSegments(elapsed);
      handleFinalBlinkScheduling();      // only BEFORE end

      if (elapsed >= totalSec){
        // OVERTIME visuals: whole background yellow; digits strong blue; clock strip transparent
        root.classList.add('overtime');
        clockStrip.style.background = 'transparent';

        const minutesOver = Math.floor((elapsed - totalSec) / 60);
        const atBoundary = ((elapsed - totalSec) % 60 === 0);
        if (atBoundary && minutesOver !== otBlinkMinuteDone){
          otBlinkMinuteDone = minutesOver;
          blinkClockDigits(3); // blink digits 3× each minute in OT
        }
      } else {
        clockStrip.style.background = '#000';
        root.classList.remove('overtime');
      }

      setMiniStatus();
      updateStampVisibility();
    }
    rafId = requestAnimationFrame(tick);
  }

  /* ---------- Final (RED) segment minute blinks (only before end) ---------- */
  function inFinalSegment(){
    const finalStart = bSec + gSec;
    return elapsed >= finalStart && elapsed < totalSec;
  }
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function queueBlinkSequence(n){
    while (blinking) await sleep(40);
    blinking = true;
    for (let i=0;i<n;i++){
      blinkMask.style.display = 'block'; await sleep(500);
      blinkMask.style.display = 'none';  await sleep(500);
    }
    blinkMask.style.display = 'none';
    blinking = false;
  }
  async function handleFinalBlinkScheduling(){
    if (!inFinalSegment()) return;
    const finalStart = bSec + gSec;
    const remaining = totalSec - elapsed;
    const wholeMinLeft = Math.ceil(remaining / 60);
    const atBoundary = ((elapsed - finalStart) % 60 === 0);
    if (atBoundary && [3,2,1].includes(wholeMinLeft) && !scheduledFinalBlinks.has(wholeMinLeft)){
      scheduledFinalBlinks.add(wholeMinLeft);
      await queueBlinkSequence(wholeMinLeft); // 0.5s on / 0.5s off
    }
  }

  /* ---------- Overtime: blink the CLOCK digits n× ---------- */
  async function blinkClockDigits(n){
    for (let i=0;i<n;i++){
      clock.style.opacity = '0';  await sleep(500);
      clock.style.opacity = '1';  await sleep(500);
    }
    clock.style.opacity = '1';
  }

  /* ---------- Triple-tap to open settings ---------- */
  let tapCount = 0, tapTimer = null;
  document.addEventListener('pointerdown', ()=>{
    tapCount++;
    if (tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(()=>{ tapCount = 0; }, 600);
    if (tapCount >= 3){
      tapCount = 0;
      openSettings();
    }
  });

  // Make the whole start slab clickable
  startSlab.addEventListener('click', ()=>{ if (!running) { closeSettings(); start(); } });
  startBtn.addEventListener('click', ()=>{ closeSettings(); start(); });

  // Settings open/close
  const openSettings = ()=>{
    sheet.classList.add('open');
    setMiniStatus();
    updateStampVisibility();
  };
  const closeSettings = ()=>{
    sheet.classList.remove('open');
    updateStampVisibility();
  };

  // Settings buttons
  pauseBtn.addEventListener('click', ()=>{ pause(); setMiniStatus(); });
  returnBtn.addEventListener('click', ()=>{ saveTimes(); closeSettings(); });
  resetBtn.addEventListener('click', ()=>{ pause(); resetElapsed(); });
  defaultBtn.addEventListener('click', ()=>{
    bSec = DEFAULT_B; gSec = DEFAULT_G; rSec = DEFAULT_R;
    updateDisplayVals(); saveTimes();
  });

  // Delete All (press 3×)
  let delTap = 0, delTimer = null;
  deleteAllBtn.addEventListener('click', ()=>{
    delTap++;
    deleteAllBtn.textContent = `Delete All (${delTap}/3)`;
    if (delTimer) clearTimeout(delTimer);
    delTimer = setTimeout(()=>{
      delTap = 0; deleteAllBtn.textContent = 'Delete All (×3)';
    }, 1200);
    if (delTap >= 3){
      delTap = 0;
      bSec = 0; gSec = 0; rSec = 0;
      updateDisplayVals(); saveTimes();
      deleteAllBtn.textContent = 'Deleted';
      setTimeout(()=> deleteAllBtn.textContent = 'Delete All (×3)', 900);
    }
  });

  /* ---------- Save times / update UI ---------- */
  function saveTimes(){
    totalSec = bSec + gSec + rSec;
    refreshInfoBar();
    scheduledFinalBlinks.clear();
    otBlinkMinuteDone = -1;
    clock.textContent = fmtSS(elapsed);
    updateDigitColor();
    updateSegments(elapsed);
    positionMarkers();
    if (elapsed >= totalSec){
      root.classList.add('overtime');
      clockStrip.style.background = 'transparent';
    } else {
      root.classList.remove('overtime');
      clockStrip.style.background = '#000';
    }
    setMiniStatus();
    fitClockThrottled();
    updateStampVisibility();
  }

  // Steppers & Delete
  function updateDisplayVals(){
    document.getElementById('bMinVal').textContent = Math.floor(bSec/60);
    document.getElementById('bSecOnly').textContent = String(Math.floor(bSec%60)).padStart(2,'0');
    document.getElementById('gMinVal').textContent = Math.floor(gSec/60);
    document.getElementById('gSecOnly').textContent = String(Math.floor(gSec%60)).padStart(2,'0');
    document.getElementById('rMinVal').textContent = Math.floor(rSec/60);
    document.getElementById('rSecOnly').textContent = String(Math.floor(rSec%60)).padStart(2,'0');
  }
  function adjust(seg, kind, delta){
    const clamp = (v)=>Math.max(0, Math.min(6*60*60, v)); // up to 6h per segment
    const step = (kind==='m') ? 60 : 5; // seconds step is 5
    if (seg==='b') bSec = clamp(bSec + delta*step);
    else if (seg==='g') gSec = clamp(gSec + delta*step);
    else if (seg==='r') rSec = clamp(rSec + delta*step);
    updateDisplayVals();
    totalSec = bSec + gSec + rSec;
    refreshInfoBar(); positionMarkers(); updateSegments(elapsed); updateDigitColor(); setMiniStatus();
  }
  document.querySelectorAll('.btnStep').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const seg = btn.getAttribute('data-seg');
      const kind = btn.getAttribute('data-kind'); // 'm' or 's'
      const d = parseInt(btn.getAttribute('data-d'),10);
      adjust(seg, kind, d);
    });
  });
  document.querySelectorAll('.btnDelete').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const which = btn.getAttribute('data-del');
      if (which==='b') bSec = 0;
      if (which==='g') gSec = 0;
      if (which==='r') rSec = 0;
      updateDisplayVals();
      saveTimes();
    });
  });

  /* ---------- Init ---------- */
  applyOrientationClass();
  updateDisplayVals();
  refreshInfoBar();
  positionMarkers();
  updateSegments(0);
  clock.textContent = fmtSS(0);
  updateDigitColor();
  fitClock();
  setMiniStatus();

  window.addEventListener('resize', ()=>{ fitClockThrottled(); positionMarkers(); });
  window.addEventListener('orientationchange', ()=>{ fitClockThrottled(); positionMarkers(); });

  // Keyboard helpers
  window.addEventListener('keydown', (e)=>{
    if (e.key === ' '){ e.preventDefault(); running ? pause() : start(); }
    else if (e.key.toLowerCase()==='s'){ sheet.classList.contains('open') ? closeSettings() : openSettings(); }
    else if (e.key.toLowerCase()==='r'){ pause(); resetElapsed(); }
  });

  /* ---------- helpers ---------- */
  function throttle(fn, ms){
    let last = 0, t;
    return function(){
      const now = performance.now();
      if (now - last >= ms){ last = now; fn(); }
      else { clearTimeout(t); t = setTimeout(()=>{ last = performance.now(); fn(); }, ms - (now - last)); }
    };
  }

})();
</script>
</body>
</html>
