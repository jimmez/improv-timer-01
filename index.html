<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Improv Timer v11 (RGB)</title>
<style>
  :root{
    --red:#ff0000;
    --green:#25d366;
    --blue:#3aa8ff;

    --bg:#000000;
    --fg:#ffffff;
    --danger:#ff2222;

    /* Bands take the remaining space above/below the clock.
       You can nudge their min/max here if needed. */
    --band-min: 24px;   /* never smaller than this */
    --band-max: 22vh;   /* never taller than this each */
  }

  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    overflow:hidden;
  }

  .app{position:relative;height:100%;width:100%;display:flex;flex-direction:column;}
  .field{
    position:relative;flex:1 1 auto;overflow:hidden;background:var(--bg);
    display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:100%;
  }

  /* ====== PROGRESS BANDS (top & bottom) ====== */
  .band{
    position:relative; /* grid child */
    min-height:var(--band-min);
    max-height:var(--band-max);
    height:clamp(var(--band-min), 16vh, var(--band-max));
    overflow:hidden; z-index:1;
  }
  .segments{position:absolute;inset:0;display:flex;pointer-events:none;}
  .seg{height:100%;width:0}
  .seg.red{background:var(--red)}
  .seg.green{background:var(--green)}
  .seg.blue{background:var(--blue)}

  /* Marker lines exist ONLY inside the bands */
  .markers{position:absolute;inset:0;pointer-events:none;}
  .marker{position:absolute;top:0;bottom:0;width:2px;opacity:.98;}
  .marker.red{background:var(--red)}
  .marker.green{background:var(--green)}
  .marker.end{background:var(--blue);width:3px;} /* end line a bit thicker */

  /* ====== CLOCK STRIP (always black background) ====== */
  .clock-strip{
    position:relative; /* grid middle row (1fr) */
    background:#000; /* guarantees no bars behind numbers */
    z-index:2;display:flex;align-items:center;justify-content:center;
    user-select:none;
  }
  .time-rot{transform-origin:center;}
  .portrait .time-rot{ transform: rotate(-90deg); }  /* portrait: bottom→top */
  .landscape .time-rot{ transform: none; }

  .time{
    display:block;line-height:0.9;font-weight:900;letter-spacing:0.02em;white-space:nowrap;
    text-shadow:0 0 22px rgba(0,0,0,.7);
    color:var(--red); /* will change with segment: red/green/blue */
    font-size:10vw; /* JS fits to max */
  }

  /* Blink overlay (0.5s color / 0.5s black handled in JS), only over the clock strip */
  .blink-mask{
    position:absolute;inset:0;background:#000;pointer-events:none;z-index:3;display:none;
  }

  /* End-of-timer black/red blink (full screen) */
  .end-blink{position:absolute;inset:0;pointer-events:none;z-index:4;background:var(--bg);
    animation:endBlink .5s steps(2,jump-none) infinite;display:none;}
  @keyframes endBlink{0%{background:var(--bg)}50%{background:var(--danger)}100%{background:var(--danger)}}

  /* Big total overlay – tuck into the bottom band, right corner */
  .total-overlay{
    position:absolute;right:10px;bottom:6px;z-index:2;
    font-weight:900;font-variant-numeric:tabular-nums;
    font-size:clamp(14px, 3.8vw, 28px);
    color:#ffffff;text-shadow:0 0 16px rgba(0,0,0,.6);
    background:rgba(0,0,0,.35);padding:2px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.12);
  }

  /* Bottom info bar */
  .bar{flex:0 0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px;
    background:rgba(0,0,0,.55);backdrop-filter:blur(4px);border-top:1px solid rgba(255,255,255,.08);
    font-size:clamp(12px,2.4vw,18px);z-index:5;}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;
    display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
  .dot.red{background:var(--red)} .dot.green{background:var(--green)} .dot.blue{background:var(--blue)}
  .bar .spacer{flex:1}
  .bar strong#totalShow{font-size:1.25em}

  /* Start slab (left 20%) */
  .start-slab{
    position:absolute;left:0;top:0;bottom:0;width:20%;
    display:flex;align-items:center;justify-content:center;
    background:rgba(58,168,255,0.07);border-right:1px solid rgba(255,255,255,.12);
    cursor:pointer;user-select:none;z-index:6;
  }
  .start-slab button{
    width:88%;max-width:340px;padding:18px 12px;border-radius:16px;
    border:2px solid rgba(255,255,255,.28);background:var(--blue);color:#002235;
    font-weight:900;font-size:clamp(18px,3.8vw,28px);box-shadow:0 10px 30px rgba(0,0,0,.45);cursor:pointer;
  }
  .start-hidden{display:none;}

  /* Settings sheet (triple-tap) */
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.66);display:none;align-items:center;justify-content:center;z-index:11;}
  .sheet.open{display:flex}
  .card{
    width:min(900px,92vw);
    max-height:92vh;
    background:#0b0b0b;color:var(--fg);
    border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);
    padding:0;display:flex;flex-direction:column;overflow:hidden;
  }
  .card-header{
    position:sticky;top:0;z-index:2;
    background:linear-gradient(180deg,#0b0b0b 85%,rgba(11,11,11,0) 100%);
    padding:14px 16px 10px 16px;border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
  }
  .card-title{margin:0;font-size:18px;font-weight:800;}
  .status{
    display:flex;align-items:center;gap:10px;font-variant-numeric:tabular-nums;
    background:rgba(255,255,255,.06);padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
  }
  .status .dot{width:10px;height:10px;border-radius:50%;}
  .status .dot.run{background:#28d17c}
  .status .dot.pause{background:#ffb020}
  .status .dot.reset{background:#aaaaaa}
  .mini-time{font-weight:900;letter-spacing:0.02em}
  .mini-total{opacity:.8}
  .mini-divider{opacity:.6}

  .card-body{padding:12px 16px;overflow:auto;}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .row + .row{margin-top:12px;}
  .group{flex:1 1 260px;min-width:260px;background:#121212;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:12px;}

  .group.themed{position:relative;--theme:#fff;}
  .group.themed h4{margin:0 0 8px 0;display:flex;align-items:center;gap:8px;font-size:16px;color:var(--theme)}
  .group.themed .lbl{color:var(--theme);opacity:.9}
  .group.themed .val{border-color:color-mix(in srgb, var(--theme) 40%, #ffffff 20%);color:var(--theme)}
  .group.themed .btnStep{
    border:1px solid; border-color:color-mix(in srgb, var(--theme) 60%, #ffffff 10%);
    color:#000; background:color-mix(in srgb, var(--theme) 50%, #101010 50%);
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
  }
  .group.red   { --theme: #ff5a2f; } /* slightly orange in settings only */
  .group.green { --theme: var(--green); }
  .group.blue  { --theme: var(--blue); }

  .counter{display:flex;align-items:center;gap:8px;margin-top:6px;}
  .lbl{opacity:.8;font-size:12px;min-width:70px}
  .btnStep{padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer;min-width:44px;text-align:center}
  .val{padding:6px 10px;border:1px dashed rgba(255,255,255,.24);border-radius:10px;min-width:72px;text-align:center;font-variant-numeric:tabular-nums;}

  .card-footer{
    position:sticky;bottom:0;z-index:2;
    background:linear-gradient(0deg,#0b0b0b 82%,rgba(11,11,11,0) 100%);
    border-top:1px solid rgba(255,255,255,.12);
    padding:10px 16px calc(10px + env(safe-area-inset-bottom)) 16px;
    display:flex;align-items:center;gap:12px;
  }
  .btn{border:1px solid rgba(255,255,255,.18);background:#101010;color:var(--fg);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;}
  .btn.primary{background:var(--blue);color:#002235}
  .btn.warn{background:#1a0000;color:#ffb3b3;border-color:#551111}

  /* Watermark (only before start and first 10 seconds) */
  .stamp{
    position:fixed;right:10px;top:8px;z-index:12;font-size:12px;opacity:0.85;letter-spacing:0.4px;
    background:rgba(0,0,0,0.35);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);
  }
  .stamp.hidden{display:none;}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="stamp" id="stamp">08.09.2025 - v11 - Jimmy James</div>

    <div class="field" id="field">
      <!-- TOP progress band -->
      <div class="band" id="bandTop">
        <div class="segments">
          <div class="seg red"   id="segR_top"></div>
          <div class="seg green" id="segG_top"></div>
          <div class="seg blue"  id="segB_top"></div>
        </div>
        <div class="markers">
          <div class="marker red"   id="lineR_top"></div>
          <div class="marker green" id="lineG_top"></div>
          <div class="marker end"   id="lineEnd_top"></div>
        </div>
      </div>

      <!-- CLOCK strip (always black under numbers) -->
      <div class="clock-strip" id="clockStrip">
        <div class="time-rot">
          <span class="time" id="clock">0:00</span>
        </div>
        <!-- Blink mask only overlays the clock area -->
        <div class="blink-mask" id="blinkMask"></div>
      </div>

      <!-- BOTTOM progress band -->
      <div class="band" id="bandBottom">
        <div class="segments">
          <div class="seg red"   id="segR_bot"></div>
          <div class="seg green" id="segG_bot"></div>
          <div class="seg blue"  id="segB_bot"></div>
        </div>
        <div class="markers">
          <div class="marker red"   id="lineR_bot"></div>
          <div class="marker green" id="lineG_bot"></div>
          <div class="marker end"   id="lineEnd_bot"></div>
        </div>

        <!-- Big total lives visually with the bottom band -->
        <div class="total-overlay" id="totalOverlay">20:00</div>
      </div>

      <!-- End blink covers everything when finished -->
      <div class="end-blink" id="endBlink"></div>

      <!-- Big left START slab -->
      <div class="start-slab" id="startSlab">
        <button id="startBtn">START</button>
      </div>
    </div>

    <!-- Bottom info bar -->
    <div class="bar">
      <span class="pill"><span class="dot red"></span><span id="rShow">4:00</span></span>
      <span class="pill"><span class="dot green"></span><span id="gShow">10:00</span></span>
      <span class="pill"><span class="dot blue"></span><span id="bShow">6:00</span></span>
      <div class="spacer"></div>
      <span class="pill" title="Total time"><strong id="totalShow">20:00</strong></span>
    </div>

    <!-- Settings (opens via triple tap anywhere) -->
    <div class="sheet" id="sheet">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Improv Timer Settings</h2>
          <div class="status" id="statusBox">
            <span class="dot pause" id="miniDot"></span>
            <span id="miniStatus">Paused</span>
            <span class="mini-divider">·</span>
            <span class="mini-time" id="miniClock">0:00</span>
            <span class="mini-total" id="miniTotal">/ 20:00</span>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <!-- 1. Red (slightly orange theme in settings only) -->
            <div class="group themed red">
              <h4><span>1.</span> <span class="dot" style="background:#ff5a2f"></span> <strong>Red</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="-1">−</button>
                <span class="val" id="rMinVal">4</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="1">+</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="rSecOnly">00</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <!-- 2. Green -->
            <div class="group themed green">
              <h4><span>2.</span> <span class="dot green"></span> <strong>Green</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="-1">−</button>
                <span class="val" id="gMinVal">10</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="1">+</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="gSecOnly">00</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <!-- 3. Blue -->
            <div class="group themed blue">
              <h4><span>3.</span> <span class="dot blue"></span> <strong>Blue</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="-1">−</button>
                <span class="val" id="bMinVal">6</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="1">+</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (×5)</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="-1">−5</button>
                <span class="val" id="bSecOnly">00</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="1">+5</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn" id="pauseBtn">Pause</button>
          <button class="btn primary" id="returnBtn">Return</button>
          <button class="btn warn" id="resetBtn" title="Reset timer to 0">Reset</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const root = document.body;

  const clock = document.getElementById('clock');
  const clockStrip = document.getElementById('clockStrip');

  // top band segments
  const segR_top = document.getElementById('segR_top');
  const segG_top = document.getElementById('segG_top');
  const segB_top = document.getElementById('segB_top');
  // bottom band segments
  const segR_bot = document.getElementById('segR_bot');
  const segG_bot = document.getElementById('segG_bot');
  const segB_bot = document.getElementById('segB_bot');

  // markers in top band
  const lineR_top = document.getElementById('lineR_top');
  const lineG_top = document.getElementById('lineG_top');
  const lineEnd_top = document.getElementById('lineEnd_top');
  // markers in bottom band
  const lineR_bot = document.getElementById('lineR_bot');
  const lineG_bot = document.getElementById('lineG_bot');
  const lineEnd_bot = document.getElementById('lineEnd_bot');

  const blinkMask = document.getElementById('blinkMask');
  const endBlink = document.getElementById('endBlink');

  const rShow = document.getElementById('rShow');
  const gShow = document.getElementById('gShow');
  const bShow = document.getElementById('bShow');
  const totalShow = document.getElementById('totalShow');
  const totalOverlay = document.getElementById('totalOverlay');

  const startSlab = document.getElementById('startSlab');
  const startBtn = document.getElementById('startBtn');

  const sheet = document.getElementById('sheet');
  const pauseBtn = document.getElementById('pauseBtn');
  const returnBtn = document.getElementById('returnBtn');
  const resetBtn = document.getElementById('resetBtn');

  const miniDot = document.getElementById('miniDot');
  const miniStatus = document.getElementById('miniStatus');
  const miniClock = document.getElementById('miniClock');
  const miniTotal = document.getElementById('miniTotal');

  const rMinVal = document.getElementById('rMinVal');
  const rSecOnly = document.getElementById('rSecOnly');
  const gMinVal = document.getElementById('gMinVal');
  const gSecOnly = document.getElementById('gSecOnly');
  const bMinVal = document.getElementById('bMinVal');
  const bSecOnly = document.getElementById('bSecOnly');

  const stamp = document.getElementById('stamp');

  // State (seconds) in RGB order — defaults: 4 / 10 / 6
  let rSec = 4*60, gSec = 10*60, bSec = 6*60;
  let totalSec = rSec + gSec + bSec;

  let elapsed = 0; // seconds
  let running = false;
  let rafId = null;
  let lastTick = null;

  let scheduledFinalBlinks = new Set();
  let blinking = false;

  /* ---------- Orientation handling ---------- */
  function applyOrientationClass(){
    const portrait = window.innerHeight >= window.innerWidth;
    root.classList.toggle('portrait', portrait);
    root.classList.toggle('landscape', !portrait);
  }

  /* ---------- Fit the giant clock exactly like before ---------- */
  function fitClock(){
    const rect = clockStrip.getBoundingClientRect();
    if (rect.width <= 0 || rect.height <= 0) return;

    const isPortrait = root.classList.contains('portrait');

    if (isPortrait){
      const maxRotW = rect.width * 0.98;
      const maxRotH = rect.height * 0.96;
      let lo=4, hi=Math.max(12, rect.height);
      const fits = (px)=>{
        clock.style.fontSize = px + 'px';
        const W = clock.scrollWidth, H = clock.scrollHeight;
        const rotW = H, rotH = W; // 90° rotated
        return (rotW <= maxRotW) && (rotH <= maxRotH);
      };
      while (fits(hi) && hi < rect.height*3) hi *= 1.25;
      while (hi - lo > 1){ const mid = Math.floor((lo+hi)/2); if (fits(mid)) lo = mid; else hi = mid; }
      clock.style.fontSize = lo + 'px';
    } else {
      const maxW = rect.width * 0.98;
      const maxH = rect.height * 0.92;
      let lo=4, hi=Math.max(12, rect.height);
      const fits = (px)=>{
        clock.style.fontSize = px + 'px';
        const W = clock.scrollWidth, H = clock.scrollHeight;
        return (H <= maxH) && (W <= maxW);
      };
      while (fits(hi) && hi < rect.height*3) hi *= 1.25;
      while (hi - lo > 1){ const mid = Math.floor((lo+hi)/2); if (fits(mid)) lo = mid; else hi = mid; }
      clock.style.fontSize = lo + 'px';
    }
  }

  const fitClockThrottled = throttle(()=>{ applyOrientationClass(); fitClock(); }, 50);

  /* ---------- Formatters ---------- */
  function fmtSS(t){
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  /* ---------- Digit color per segment (now red/green/blue) ---------- */
  function updateDigitColor(){
    const rEnd = rSec;
    const gEnd = rSec + gSec;
    if (elapsed < rEnd){
      clock.style.color = getComputedStyle(document.documentElement).getPropertyValue('--red');
    } else if (elapsed < gEnd){
      clock.style.color = getComputedStyle(document.documentElement).getPropertyValue('--green');
    } else {
      clock.style.color = getComputedStyle(document.documentElement).getPropertyValue('--blue');
    }
  }

  /* ---------- Markers (only inside bands) ---------- */
  function positionMarkers(){
    const rPct = totalSec ? (rSec/totalSec)*100 : 0;
    const gPct = totalSec ? ((rSec+gSec)/totalSec)*100 : 0;
    const endPct = 100;

    lineR_top.style.left = lineR_bot.style.left = `calc(${rPct}% - 1px)`;
    lineG_top.style.left = lineG_bot.style.left = `calc(${gPct}% - 1px)`;
    lineEnd_top.style.left = lineEnd_bot.style.left = `calc(${endPct}% - 1px)`;
  }

  function refreshInfoBar(){
    rShow.textContent = fmtSS(rSec);
    gShow.textContent = fmtSS(gSec);
    bShow.textContent = fmtSS(bSec);
    const totalTxt = fmtSS(totalSec);
    totalShow.textContent = totalTxt;
    totalOverla