<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Improv Timer v43</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root{
    --blue:#3aa8ff;
    --green:#25d366;
    --yellow:#ffff33;
    --red:#ff3b00;
    --bg:#000; --fg:#fff;
    --band-min:26px; --band-max:22vh;
    --overtime-yellow:#ffff00; --overtime-blue:#0044ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden;-webkit-tap-highlight-color:transparent;transition:background-color .2s linear;}
  body.overtime{background:var(--overtime-yellow);}
  .app{position:relative;height:100%;width:100%;display:flex;flex-direction:column;padding-bottom:env(safe-area-inset-bottom);}
  .field{position:relative;flex:1 1 auto;display:grid;grid-template-rows:1fr auto;grid-template-columns:100%;}

  /* CLOCK */
  .clock-strip{position:relative;z-index:2;background:#000;display:flex;align-items:center;justify-content:center;user-select:none;transition:background .15s linear;}
  .time-rot{transform-origin:center;}
  .time{display:block;line-height:.88;font-weight:900;letter-spacing:.005em;white-space:nowrap;text-shadow:0 0 22px rgba(0,0,0,.7);color:var(--blue);font-size:10vw;transition:opacity .12s linear,color .12s linear;}

  .overtime-ribbon{position:absolute;left:10px;top:0;bottom:0;z-index:4;width:58px;display:none;align-items:center;justify-content:center;background:rgba(255,0,0,.18);border-left:1px solid rgba(255,0,0,.55);border-right:1px solid rgba(255,255,255,.18);backdrop-filter:blur(1px);}
  .overtime .overtime-ribbon{display:flex;}
  .overtime-text{writing-mode:vertical-lr;text-orientation:upright;white-space:pre-line;font-weight:900;font-size:14px;letter-spacing:.8px;color:#fff;text-shadow:0 0 8px rgba(0,0,0,.5);}

  .blink-mask{position:absolute;inset:0;background:#000;pointer-events:none;z-index:3;display:none;}

  /* Progress band */
  .band{position:relative;min-height:var(--band-min);max-height:var(--band-max);height:clamp(var(--band-min),15vh,var(--band-max));overflow:hidden;z-index:1;}
  .segments{position:absolute;inset:0;display:flex;pointer-events:none;}
  .seg{height:100%;width:0}
  .seg.blue{background:var(--blue)} .seg.green{background:var(--green)} .seg.yellow{background:var(--yellow)} .seg.red{background:var(--red)}

  .markers{position:absolute;inset:0;pointer-events:none;}
  .marker{position:absolute;top:0;bottom:0;width:2px;}
  .marker.m04{background:var(--green)} .marker.m14{background:var(--yellow)} .marker.m17{background:var(--red)} .marker.end{background:var(--red);width:5px;}
  .marker-label{position:absolute;bottom:6px;transform:translateX(6px);font-size:12px;font-weight:800;font-variant-numeric:tabular-nums;padding:2px 6px;border-radius:6px;white-space:nowrap;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);}
  .marker-label.g{color:var(--green)} .marker-label.y{color:var(--yellow)} .marker-label.r{color:var(--red)}

  /* Bottom info bar */
  .bar{flex:0 0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);border-top:1px solid rgba(255,255,255,.08);font-size:clamp(12px,2.4vw,18px);z-index:5;}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
  .dot.blue{background:var(--blue)} .dot.green{background:var(--green)} .dot.yellow{background:var(--yellow)} .dot.red{background:var(--red)}
  .bar .spacer{flex:1} .bar strong#totalShow{font-size:1.25em}

  /* READY/PAUSE overlay */
  .state-overlay{position:absolute;inset:0;z-index:6;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.28);backdrop-filter:blur(1px);} 
  .state-overlay.hidden{display:none}
  .state-label{font-weight:1000;letter-spacing:.04em;font-size:clamp(26px,7vw,88px);text-transform:uppercase;text-shadow:0 0 18px rgba(0,0,0,.6);}

  /* Mid-screen row for Reset (left) + Presets (right) */
  .state-row{position:absolute;left:12px;right:12px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:12px;}
  .state-row .spacer{flex:1}

  .hud-tip{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);font-size:12px;opacity:.85;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);user-select:none;}

  /* Buttons */
  .btn,.btn:focus,.btn:active{outline:none;}
  .btn{border:1px solid rgba(255,255,255,.18);background:#101010;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;font-size:14px;user-select:none;}
  .btn.primary{background:var(--blue);color:#002235}
  .btn.warn{background:#1a0000;color:#ffb3b3;border-color:#551111}
  .btn.neutral{background:#0f0f0f}
  .btn:active{transform:scale(.98)}

  /* Quad size for overlay controls */
  .btn.quad{padding:40px 56px;font-size:28px;border-radius:18px;}

  /* Settings sheet etc. (unchanged) */
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.66);display:none;align-items:center;justify-content:center;z-index:11;}
  .sheet.open{display:flex}
  .card{width:min(980px,94vw);max-height:92vh;background:#0b0b0b;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:0;display:flex;flex-direction:column;overflow:hidden;}
  .card-header{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,#0b0b0b 85%,rgba(11,11,11,0) 100%);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:flex-end;justify-content:space-between;gap:8px;}
  .card-title{margin:0;font-size:16px;font-weight:800;}
  .status{display:flex;align-items:center;gap:8px;font-variant-numeric:tabular-nums;background:rgba(255,255,255,.06);padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);font-size:12px;}
  .status .dot{width:9px;height:9px;border-radius:50%;}.status .dot.run{background:#28d17c}.status .dot.pause{background:#ffb020}.status .dot.reset{background:#aaaaaa}
  .mini-time{font-weight:900;letter-spacing:.02em}.mini-total{opacity:.8}.mini-divider{opacity:.6}

  .card-body{padding:10px 12px;overflow:auto;}
  .row{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap;} .row + .row{margin-top:10px;}
  .group{flex:1 1 230px;min-width:230px;max-width:100%;background:#121212;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px;}
  .group.themed{--theme:#fff;} .group.themed h4{margin:0 0 6px 0;display:flex;align-items:center;gap:6px;font-size:14px;color:var(--theme)}
  .group.themed .lbl{color:var(--theme);opacity:.9} .group.themed .val{border:1px dashed rgba(255,255,255,.24);color:var(--theme)} .group.themed .btnStep{border:1px solid rgba(255,255,255,.24);color:#000;background:#e6e6e6;}
  .group.blue{--theme:var(--blue)} .group.green{--theme:var(--green)} .group.yellow{--theme:var(--yellow)} .group.red{--theme:var(--red)}
  .counter{display:flex;align-items:center;gap:6px;margin-top:6px;flex-wrap:nowrap;}
  .lbl{opacity:.8;font-size:11px;min-width:64px}
  .btnStep{padding:6px 8px;border-radius:10px;font-weight:800;cursor:pointer;min-width:36px;text-align:center;font-size:12px}
  .val{padding:6px 8px;border-radius:10px;min-width:56px;text-align:center;font-variant-numeric:tabular-nums;background:#0b0b0b;border:1px dashed rgba(255,255,255,.24);color:#fff;}
  .btnDelete{padding:6px 8px;border-radius:10px;font-weight:800;cursor:pointer;border:1px solid #522;background:#1a0000;color:#ffb3b3;font-size:12px}

  .group.preview{display:none;align-items:center;justify-content:center;text-align:center;gap:8px;}
  .previewTitle{font-weight:800;font-size:13px;opacity:.9;margin:0 0 6px 0}
  .previewClock{font-weight:900;font-variant-numeric:tabular-nums;font-size:clamp(22px,5vw,48px);line-height:1;letter-spacing:.02em;background:#000;border-radius:10px;padding:10px 12px;display:inline-block;border:1px solid rgba(255,255,255,.14);}
  .previewState{margin-top:6px;font-size:12px;opacity:.85}

  @media (orientation:landscape){
    .card-body .row{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:minmax(140px,auto);gap:10px;}
    .group.preview{display:flex;flex-direction:column;}
    .group.blue{order:1}.group.green{order:2}.group.yellow{order:3}.group.red{order:4}.group.preview{order:5}
  }

  /* HUD */
  .hud-badge,.hud-clock{position:fixed;z-index:10;display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);backdrop-filter:blur(2px);font-weight:900;letter-spacing:.02em;font-variant-numeric:tabular-nums;user-select:none;pointer-events:none;}
  .hud-badge{right:10px;top:8px;font-size:12px}.hud-clock{left:10px;top:8px;font-size:14px;color:#fff}

  /* Watermark */
  .wm{position:fixed;left:50%;bottom:8px;transform:translateX(-50%);z-index:9;font-size:12px;opacity:0;transition:opacity .2s linear;padding:2px 8px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);pointer-events:none;}
  .wm.show{opacity:1}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="hud-clock" id="nowClock">00:00</div>
    <div class="hud-badge" id="versionBadge">v43</div>
    <div class="wm" id="wm">Jimmy James â€“ 16.10.2025</div>

    <div class="field" id="field">
      <!-- CLOCK -->
      <div class="clock-strip" id="clockStrip">
        <div class="overtime-ribbon" id="otRibbon"><span class="overtime-text">OVER
TIME</span></div>
        <div class="time-rot"><span class="time" id="clock">0:00</span></div>
        <div class="blink-mask" id="blinkMask"></div>
      </div>

      <!-- Progress band -->
      <div class="band" id="bandBottom">
        <div class="segments">
          <div class="seg blue" id="segB"></div>
          <div class="seg green" id="segG"></div>
          <div class="seg yellow" id="segY"></div>
          <div class="seg red" id="segR"></div>
        </div>
        <div class="markers">
          <div class="marker m04" id="line04"></div>
          <div class="marker m14" id="line14"></div>
          <div class="marker m17" id="line17"></div>
          <div class="marker end" id="lineEnd"></div>
          <div class="marker-label g" id="label04">4:00</div>
          <div class="marker-label y" id="label14">14:00</div>
          <div class="marker-label r" id="label17">17:00</div>
        </div>
      </div>

      <!-- READY / PAUSE overlay -->
      <div class="state-overlay" id="stateOverlay" aria-hidden="false">
        <div class="state-label" id="stateLabel">READY</div>

        <!-- Mid-screen row with big Reset and Presets -->
        <div class="state-row">
          <button class="btn warn quad" id="resetBtn2" style="display:none">Reset</button>
          <div class="spacer"></div>
          <button class="btn neutral quad" id="presetBtn">Presets</button>
        </div>

        <div class="hud-tip" id="tapTip">Tap anywhere to start Â· Space toggles</div>
      </div>
    </div>

    <!-- Bottom info bar -->
    <div class="bar">
      <span class="pill"><span class="dot blue"></span><span id="bShow">4:00</span></span>
      <span class="pill"><span class="dot green"></span><span id="gShow">10:00</span></span>
      <span class="pill"><span class="dot yellow"></span><span id="yShow">3:00</span></span>
      <span class="pill"><span class="dot red"></span><span id="rShow">3:00</span></span>
      <div class="spacer"></div>
      <span class="pill" title="Total time"><strong id="totalShow">20:00</strong></span>
    </div>

    <!-- Settings (Edit page) -->
    <div class="sheet" id="sheet">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Improv Timer Settings</h2>
          <div class="status" id="statusBox">
            <span class="dot pause" id="miniDot"></span>
            <span id="miniStatus">Paused</span>
            <span class="mini-divider">Â·</span>
            <span class="mini-time" id="miniClock">0:00</span>
            <span class="mini-total" id="miniTotal">/ 20:00</span>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="group themed blue">
              <h4><span>1.</span> <span class="dot blue"></span> <strong>Blue</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="-1">â€“</button>
                <span class="val" id="bMinVal">4</span>
                <button class="btnStep" data-seg="b" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="b">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (Ã—5)</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="-1">â€“5</button>
                <span class="val" id="bSecOnly">00</span>
                <button class="btnStep" data-seg="b" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <div class="group themed green">
              <h4><span>2.</span> <span class="dot green"></span> <strong>Green</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="-1">â€“</button>
                <span class="val" id="gMinVal">10</span>
                <button class="btnStep" data-seg="g" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="g">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (Ã—5)</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="-1">â€“5</button>
                <span class="val" id="gSecOnly">00</span>
                <button class="btnStep" data-seg="g" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <div class="group themed yellow">
              <h4><span>3.</span> <span class="dot yellow"></span> <strong>Yellow</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="y" data-kind="m" data-d="-1">â€“</button>
                <span class="val" id="yMinVal">3</span>
                <button class="btnStep" data-seg="y" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="y">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (Ã—5)</span>
                <button class="btnStep" data-seg="y" data-kind="s" data-d="-1">â€“5</button>
                <span class="val" id="ySecOnly">00</span>
                <button class="btnStep" data-seg="y" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <div class="group themed red">
              <h4><span>4.</span> <span class="dot red"></span> <strong>Red</strong></h4>
              <div class="counter">
                <span class="lbl">Minutes</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="-1">â€“</button>
                <span class="val" id="rMinVal">3</span>
                <button class="btnStep" data-seg="r" data-kind="m" data-d="1">+</button>
                <button class="btnDelete" data-del="r">Delete</button>
              </div>
              <div class="counter">
                <span class="lbl">Seconds (Ã—5)</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="-1">â€“5</button>
                <span class="val" id="rSecOnly">00</span>
                <button class="btnStep" data-seg="r" data-kind="s" data-d="1">+5</button>
              </div>
            </div>

            <div class="group preview" id="previewBlock">
              <h4 class="previewTitle">Preview</h4>
              <div class="previewClock" id="previewClock">0:00</div>
              <div class="previewState" id="previewState">Paused</div>
            </div>
          </div>
        </div>

        <div class="card-footer" style="padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="pauseBtn">Pause</button>
          <button class="btn primary" id="returnBtn">Return</button>
          <button class="btn warn" id="resetBtn">Reset</button>

          <button class="btn neutral" id="preset20Btn" title="Blue 4m, Green 10m, Yellow 3m, Red 3m">20</button>
          <button class="btn neutral" id="preset25Btn" title="Blue 4m, Green 15m, Yellow 3m, Red 3m">25</button>
          <button class="btn neutral" id="preset9Btn" title="Blue 2m, Green 4m, Yellow 1m, Red 2m">9</button>
          <button class="btn neutral" id="presetShortBtn" title="Blue 5s, Green 5s, Yellow 5s, Red 5s">Short</button>
          <button class="btn neutral" id="presetClapBtn" title="Blue 2m, Green to 9:00, Yellow to 17:00, Red to 20:00">Clap</button>

          <button class="btn warn" id="deleteAllBtn" title="Press 3Ã— to delete all">Delete All (Ã—3)</button>
        </div>
      </div>
    </div>

    <!-- Preset Picker -->
    <div class="sheet" id="presetSheet">
      <div class="card" style="max-width:560px">
        <div class="card-header"><h2 class="card-title">Choose a Preset</h2></div>
        <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-preset="20">20</button>
          <button class="btn primary" data-preset="25">25</button>
          <button class="btn primary" data-preset="9">9</button>
          <button class="btn primary" data-preset="short">Short</button>
          <button class="btn primary" data-preset="clap">Clap</button>
        </div>
        <div class="card-footer" style="padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="presetEditBtn">Editâ€¦</button>
          <button class="btn neutral" id="presetCloseBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const root=document.body;
  const clock=document.getElementById('clock');
  const clockStrip=document.getElementById('clockStrip');
  const blinkMask=document.getElementById('blinkMask');
  const field=document.getElementById('field');

  // Overlay
  const overlay=document.getElementById('stateOverlay');
  const stateLabel=document.getElementById('stateLabel');
  const resetBtn2=document.getElementById('resetBtn2');
  const presetBtn=document.getElementById('presetBtn');
  const tapTip=document.getElementById('tapTip');

  // Segments
  const segB=document.getElementById('segB');
  const segG=document.getElementById('segG');
  const segY=document.getElementById('segY');
  const segR=document.getElementById('segR');

  // Markers
  const line04=document.getElementById('line04');
  const line14=document.getElementById('line14');
  const line17=document.getElementById('line17');
  const lineEnd=document.getElementById('lineEnd');

  const label04=document.getElementById('label04');
  const label14=document.getElementById('label14');
  const label17=document.getElementById('label17');

  // HUD info bar
  const bShow=document.getElementById('bShow');
  const gShow=document.getElementById('gShow');
  const yShow=document.getElementById('yShow');
  const rShow=document.getElementById('rShow');
  const totalShow=document.getElementById('totalShow');

  // HUD
  const nowClock=document.getElementById('nowClock');
  const versionBadge=document.getElementById('versionBadge');
  const wm=document.getElementById('wm');
  let wmTimer=null;
  function showWM(){ wm.textContent='Jimmy James â€“ 16.10.2025'; wm.classList.add('show'); if(wmTimer)clearTimeout(wmTimer); wmTimer=setTimeout(()=>wm.classList.remove('show'),5000); }

  // Settings (unchanged)
  const sheet=document.getElementById('sheet');
  const pauseBtn=document.getElementById('pauseBtn');
  const returnBtn=document.getElementById('returnBtn');
  const resetBtn=document.getElementById('resetBtn');
  const deleteAllBtn=document.getElementById('deleteAllBtn');

  const preset20Btn=document.getElementById('preset20Btn');
  const preset25Btn=document.getElementById('preset25Btn');
  const preset9Btn=document.getElementById('preset9Btn');
  const presetShortBtn=document.getElementById('presetShortBtn');
  const presetClapBtn=document.getElementById('presetClapBtn');

  const miniDot=document.getElementById('miniDot');
  const miniStatus=document.getElementById('miniStatus');
  const miniClock=document.getElementById('miniClock');
  const miniTotal=document.getElementById('miniTotal');

  const previewClock=document.getElementById('previewClock');
  const previewState=document.getElementById('previewState');

  // Preset sheet
  const presetSheet=document.getElementById('presetSheet');
  const presetEditBtn=document.getElementById('presetEditBtn');
  const presetCloseBtn=document.getElementById('presetCloseBtn');

  // Defaults
  const DEFAULT_B=240, DEFAULT_G=600, DEFAULT_Y=180, DEFAULT_R=180;
  let bSec=DEFAULT_B, gSec=DEFAULT_G, ySec=DEFAULT_Y, rSec=DEFAULT_R;
  let totalSec=bSec+gSec+ySec+rSec;

  // Timer state
  let elapsed=0; // seconds
  let running=false;
  let rafId=null;
  let lastTick=null;

  let scheduledFinalBlinks=new Set();
  let blinking=false;
  let otBlinkMinuteDone=-1;

  function updateWmVisibility(){ if(sheet.classList.contains('open')) wm.classList.remove('show'); }

  function fitClock(){
    const rect=clockStrip.getBoundingClientRect();
    if(rect.width<=0 || rect.height<=0) return;
    const maxW=rect.width*0.998, maxH=rect.height*0.985;
    let lo=6, hi=Math.max(24, rect.height*2.1);
    const fits=px=>{ clock.style.fontSize=px+'px'; return clock.scrollHeight<=maxH && clock.scrollWidth<=maxW; };
    while(fits(hi)) hi*=1.2;
    while(hi-lo>1){ const mid=(lo+hi>>1); fits(mid)?lo=mid:hi=mid; }
    clock.style.fontSize=lo+'px';
  }
  const fitClockThrottled=(function(){ let last=0,t; return function(){ const now=performance.now(); if(now-last>=50){ last=now; fitClock(); } else { clearTimeout(t); t=setTimeout(()=>{ last=performance.now(); fitClock(); }, 50-(now-last)); } }; })();

  function fmtSS(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return m+':'+String(s).padStart(2,'0'); }
  function fmtNow24(d){ const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'); return hh+':'+mm; }
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function updateDigitColor(){
    const bEnd=bSec, gEnd=bSec+gSec, yEnd=bSec+gSec+ySec;
    let col;
    if (elapsed < bEnd)          col=getVar('--blue');
    else if (elapsed < gEnd)     col=getVar('--green');
    else if (elapsed < yEnd)     col=getVar('--yellow');
    else if (elapsed < totalSec) col=getVar('--red');
    else                         col=getVar('--overtime-blue');
    clock.style.color=col; versionBadge.style.color=col;
  }

  function positionMarkers(){
    if (totalSec<=0){
      line04.style.left=line14.style.left=line17.style.left='0%'; lineEnd.style.left='calc(100% - 2.5px)';
    } else {
      const p04=(bSec/totalSec)*100, p14=((bSec+gSec)/totalSec)*100, p17=((bSec+gSec+ySec)/totalSec)*100;
      line04.style.left=`calc(${p04}% - 1px)`;
      line14.style.left=`calc(${p14}% - 1px)`;
      line17.style.left=`calc(${p17}% - 1px)`;
      lineEnd.style.left='calc(100% - 2.5px)';
      label04.textContent=fmtSS(bSec);
      label14.textContent=fmtSS(bSec+gSec);
      label17.textContent=fmtSS(bSec+gSec+ySec);
      label04.style.left=`calc(${p04}% + 6px)`;
      label14.style.left=`calc(${p14}% + 6px)`;
      label17.style.left=`calc(${p17}% + 6px)`;
    }
    bShow.textContent=fmtSS(bSec);
    gShow.textContent=fmtSS(gSec);
    yShow.textContent=fmtSS(ySec);
    rShow.textContent=fmtSS(rSec);
    totalShow.textContent=fmtSS(totalSec);
    miniTotal.textContent='/ '+fmtSS(totalSec);
  }

  function updateSegments(sec){
    if (totalSec<=0){ segB.style.width=segG.style.width=segY.style.width=segR.style.width='0%'; return; }
    const eff=Math.min(sec,totalSec), pct=(eff/totalSec)*100;
    const bPct=(bSec/totalSec)*100, gPct=(gSec/totalSec)*100, yPct=(ySec/totalSec)*100, rPct=100-bPct-gPct-yPct;
    segB.style.width=Math.min(pct,bPct)+'%';
    segG.style.width=Math.min(Math.max(pct-bPct,0),gPct)+'%';
    segY.style.width=Math.min(Math.max(pct-bPct-gPct,0),yPct)+'%';
    segR.style.width=Math.min(Math.max(pct-bPct-gPct-yPct,0),rPct)+'%';
  }

  function setMiniStatus(){
    const txt=fmtSS(elapsed); miniClock.textContent=txt; previewClock.textContent=txt;
    let st;
    if (elapsed===0 && !running){ st='Reset'; miniDot.className='dot reset'; }
    else if (running){ st='Running'; miniDot.className='dot run'; }
    else { st='Paused'; miniDot.className='dot pause'; }
    miniStatus.textContent=st; previewState.textContent=st;
  }

  async function goFullscreenAndLockLandscape(){
    try{
      const el=document.documentElement;
      if (!document.fullscreenElement) {
        if (el.requestFullscreen)            await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      }
      if (screen.orientation && screen.orientation.lock){
        await screen.orientation.lock('landscape');
      }
    }catch(e){}
  }

  /* === START / PAUSE / READY === */
  function start(){
    if (running || totalSec===0) return;
    running=true;
    // Show GO! for 1.8s at the same spot/size as PAUSE
    stateLabel.textContent='GO!';
    overlay.classList.remove('hidden');
    setTimeout(()=> overlay.classList.add('hidden'), 1800);

    tapTip.textContent='Tap anywhere to pause Â· Space toggles';
    clockStrip.style.background='#000';
    root.classList.remove('overtime');
    lastTick=performance.now();
    setMiniStatus(); updateWmVisibility();
    tick();
  }
  function pause(){
    running=false;
    if (rafId){ cancelAnimationFrame(rafId); rafId=null; }
    overlay.classList.remove('hidden');
    stateLabel.textContent='PAUSE';
    resetBtn2.style.display='inline-flex';
    tapTip.textContent='Tap anywhere to resume Â· Space toggles';
    setMiniStatus(); updateWmVisibility();
  }
  function toReady(){
    running=false;
    if (rafId){ cancelAnimationFrame(rafId); rafId=null; }
    overlay.classList.remove('hidden');
    stateLabel.textContent='READY';
    resetBtn2.style.display='none';
    tapTip.textContent='Tap anywhere to start Â· Space toggles';
    setMiniStatus();
    showWM();
  }
  function resetElapsed(){
    elapsed=0; scheduledFinalBlinks.clear(); blinking=false; blinkMask.style.display='none'; otBlinkMinuteDone=-1;
    clock.style.opacity='1'; clockStrip.style.background='#000'; root.classList.remove('overtime');
    clock.textContent=fmtSS(0); updateDigitColor(); updateSegments(0); fitClockThrottled();
    toReady();
  }

  function tick(now){
    if (!running) return;
    if (!now) now=performance.now();
    const dt=(now-lastTick)/1000;
    if (dt>=0.25){
      const add=Math.floor(dt); elapsed+=add; lastTick+=add*1000;
      clock.textContent=fmtSS(elapsed);
      updateDigitColor(); fitClockThrottled(); updateSegments(elapsed); handleFinalBlinkScheduling();
      if (elapsed>=totalSec){
        root.classList.add('overtime'); clockStrip.style.background='transparent';
        const minutesOver=Math.floor((elapsed-totalSec)/60), atBoundary=((elapsed-totalSec)%60===0);
        if (atBoundary && minutesOver!==otBlinkMinuteDone){ otBlinkMinuteDone=minutesOver; blinkClockDigits(3); }
      } else { root.classList.remove('overtime'); clockStrip.style.background='#000'; }
      setMiniStatus(); updateWmVisibility();
    }
    rafId=requestAnimationFrame(tick);
  }

  function finalStartSec(){ return bSec + gSec + ySec; }
  function inFinalSegment(){ return elapsed >= finalStartSec() && elapsed < totalSec; }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  async function queueBlinkSequence(n){
    while (blinking) await sleep(40);
    blinking = true;
    for (let i=0;i<n;i++){ blinkMask.style.display='block'; await sleep(500); blinkMask.style.display='none'; await sleep(500); }
    blinkMask.style.display='none'; blinking=false;
  }
  async function handleFinalBlinkScheduling(){
    if (!inFinalSegment()) return;
    const finalStart = finalStartSec();
    const remaining = totalSec - elapsed;
    const wholeMinLeft = Math.ceil(remaining / 60);
    const atBoundary = ((elapsed - finalStart) % 60 === 0);
    if (atBoundary && [3,2,1].includes(wholeMinLeft)){
      const blinks = wholeMinLeft * 2;
      if (!scheduledFinalBlinks.has(blinks)){
        scheduledFinalBlinks.add(blinks);
        await queueBlinkSequence(blinks);
      }
    }
  }
  async function blinkClockDigits(n){ for (let i=0;i<n;i++){ clock.style.opacity='0'; await sleep(500); clock.style.opacity='1'; await sleep(500); } clock.style.opacity='1'; }

  // Tap anywhere to toggle
  field.addEventListener('click',(e)=>{
    if (sheet.classList.contains('open') || presetSheet.classList.contains('open')) return;
    if (e.target.closest('button')) return;
    if (running){ pause(); }
    else { goFullscreenAndLockLandscape().finally(()=> start()); }
  });

  // Overlay buttons
  presetBtn.addEventListener('click',(e)=>{ e.stopPropagation(); presetSheet.classList.add('open'); });
  resetBtn2.addEventListener('click',(e)=>{ e.stopPropagation(); resetElapsed(); });

  // Preset picker
  presetCloseBtn.addEventListener('click',()=> presetSheet.classList.remove('open'));
  presetEditBtn.addEventListener('click',()=>{ presetSheet.classList.remove('open'); openSettings(); });
  presetSheet.addEventListener('click',(e)=>{
    const btn = e.target.closest('button[data-preset]'); if (!btn) return;
    const key = btn.getAttribute('data-preset');
    if (key==='20') setFromEndpoints(240, 840, 1020, 1200);
    else if (key==='25') setFromEndpoints(240, 1140, 1320, 1500);
    else if (key==='9')  setFromEndpoints(120, 360, 420, 540);
    else if (key==='short') setFromEndpoints(5, 10, 15, 20);
    else if (key==='clap')  setFromEndpoints(120, 540, 1020, 1200);
    resetElapsed();
    presetSheet.classList.remove('open');
  });

  // Settings
  function openSettings(){ sheet.classList.add('open'); updateWmVisibility(); }
  function closeSettings(){ sheet.classList.remove('open'); updateWmVisibility(); }
  pauseBtn.addEventListener('click',()=>{ pause(); setMiniStatus(); });
  returnBtn.addEventListener('click',()=>{ closeSettings(); showWM(); });
  resetBtn.addEventListener('click',()=>{ pause(); resetElapsed(); });

  function setFromEndpoints(t1,t2,t3,tEnd){ bSec=Math.max(0,t1); gSec=Math.max(0,t2-t1); ySec=Math.max(0,t3-t2); rSec=Math.max(0,tEnd-t3); updateDisplayVals(); saveTimes(); }

  preset20Btn.addEventListener('click',()=> setFromEndpoints(240, 840, 1020, 1200));
  preset25Btn.addEventListener('click',()=> setFromEndpoints(240, 1140, 1320, 1500));
  preset9Btn .addEventListener('click',()=> setFromEndpoints(120, 360, 420, 540));
  presetShortBtn.addEventListener('click',()=> setFromEndpoints(5, 10, 15, 20));
  presetClapBtn .addEventListener('click',()=> setFromEndpoints(120, 540, 1020, 1200));

  // Delete All (Ã—3)
  let delTap=0,delTimer=null;
  deleteAllBtn.addEventListener('click',()=>{
    delTap++; deleteAllBtn.textContent=`Delete All (${delTap}/3)`;
    if (delTimer) clearTimeout(delTimer);
    delTimer=setTimeout(()=>{ delTap=0; deleteAllBtn.textContent='Delete All (Ã—3)'; },1200);
    if (delTap>=3){
      delTap=0; bSec=gSec=ySec=rSec=0; updateDisplayVals(); saveTimes();
      deleteAllBtn.textContent='Deleted'; setTimeout(()=> deleteAllBtn.textContent='Delete All (Ã—3)',900);
    }
  });

  function saveTimes(){
    totalSec=bSec+gSec+ySec+rSec;
    scheduledFinalBlinks.clear(); otBlinkMinuteDone=-1;
    clock.textContent=fmtSS(elapsed);
    updateDigitColor(); updateSegments(elapsed); positionMarkers();
    if (elapsed>=totalSec){ root.classList.add('overtime'); clockStrip.style.background='transparent'; }
    else { root.classList.remove('overtime'); clockStrip.style.background='#000'; }
    setMiniStatus(); fitClockThrottled(); updateWmVisibility();
  }

  // Settings steppers & deletes
  const bMinVal=document.getElementById('bMinVal'), bSecOnly=document.getElementById('bSecOnly');
  const gMinVal=document.getElementById('gMinVal'), gSecOnly=document.getElementById('gSecOnly');
  const yMinVal=document.getElementById('yMinVal'), ySecOnly=document.getElementById('ySecOnly');
  const rMinVal=document.getElementById('rMinVal'), rSecOnly=document.getElementById('rSecOnly');

  function updateDisplayVals(){
    bMinVal.textContent=Math.floor(bSec/60); bSecOnly.textContent=String(bSec%60).padStart(2,'0');
    gMinVal.textContent=Math.floor(gSec/60); gSecOnly.textContent=String(gSec%60).padStart(2,'0');
    yMinVal.textContent=Math.floor(ySec/60); ySecOnly.textContent=String(ySec%60).padStart(2,'0');
    rMinVal.textContent=Math.floor(rSec/60); rSecOnly.textContent=String(rSec%60).padStart(2,'0');
  }
  function adjust(seg,kind,delta){
    const clamp=v=>Math.max(0,Math.min(21600,v));
    const step=(kind==='m')?60:5;
    if(seg==='b') bSec=clamp(bSec+delta*step);
    if(seg==='g') gSec=clamp(gSec+delta*step);
    if(seg==='y') ySec=clamp(ySec+delta*step);
    if(seg==='r') rSec=clamp(rSec+delta*step);
    updateDisplayVals(); totalSec=bSec+gSec+ySec+rSec;
    positionMarkers(); updateSegments(elapsed); updateDigitColor(); setMiniStatus();
  }
  document.querySelectorAll('.btnStep').forEach(btn=>{
    btn.addEventListener('click',()=>{ adjust(btn.dataset.seg,btn.dataset.kind,parseInt(btn.dataset.d,10)); });
  });
  document.querySelectorAll('.btnDelete').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const w=btn.getAttribute('data-del');
      if(w==='b')bSec=0; if(w==='g')gSec=0; if(w==='y')ySec=0; if(w==='r')rSec=0;
      updateDisplayVals(); saveTimes();
    });
  });

  // HUD: current time
  function refreshNowClock(){ nowClock.textContent=fmtNow24(new Date()); }
  refreshNowClock();
  setInterval(refreshNowClock,10000);

  // Init
  updateDisplayVals();
  positionMarkers();
  updateSegments(0);
  clock.textContent=fmtSS(0);
  updateDigitColor();
  fitClock();
  setMiniStatus();
  toReady();

  window.addEventListener('resize',()=>{ fitClockThrottled(); positionMarkers(); });
  window.addEventListener('orientationchange',()=>{ fitClockThrottled(); positionMarkers(); });

  // Keyboard helpers
  window.addEventListener('keydown',e=>{
    if(e.key===' '){ e.preventDefault(); if (running) pause(); else start(); }
    else if(e.key.toLowerCase()==='s'){ sheet.classList.toggle('open'); updateWmVisibility(); }
    else if(e.key.toLowerCase()==='r'){ pause(); resetElapsed(); }
  });

  // Service worker (optional)
  if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }); }
})();</script>
</body>
</html>
